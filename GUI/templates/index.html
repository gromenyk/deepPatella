<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepPatella</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="banner">
        <h1>DeepPatella</h1>
        <p>Automatic quantification of patellar tendon stiffness</p>
    </div>
    <div class="main">
        <div class="col_left">
            <h2>Configurations</h2>
            <div class="video_upload">
                <form action="/upload" method="POST" enctype="multipart/form-data">
                    <label for="video" class="custom-file-upload">üìÅ Select Video</label>
                    <input type="file" id="video" name="video" accept="video/*" style="display: None;">
                    <span id="file-name" class="file-name"></span>
                    <br><br>
                    <input type="submit" id="upload-button" value="‚¨ÜÔ∏è Load Video" style="display: none;">
                </form>
                {% if message %}
                    <p class="upload-message", id="upload-message">{{ message }}</p>
                {% endif %}
            </div>
        <div class="inference">
            <form id='run-inference-form' action="/run_inference" method="POST">
                <input type="submit" id="start-inference-button" value="‚ñ∂Ô∏è Start Inference">
                <input type="submit" id="stop-inference-button" value="üõë Stop Inference">
            </form>
            {% if inference_message %}
                <p class="upload-success">{{ inference_message }}</p>
            {% endif %}
            <div class="progress-bar">
                <div id="progress-bar-fill">0%</div>
            </div>
            <div class="progress-info">
                <div id="progress-text"></div>
                <div id="progress-time"></div>
            </div>
        </div>
        </div>
        <div class="col_right">
            <h2>Visualizations</h2>
        </div>
    </div>  
    <p id="progress-info"></p>

<script>
let inferenceRunning = false;

    function toggleButton() {
        const runButton = document.getElementById('start_inference_button')
        const stopButton = document.getElementById('stop_inference_button')

        if (inferenceRunning) {
            runButton.disabled = true
            stopButton.disabled = false
        }
        else {
            runButton.disabled = false
            stopButton.disabled = true
        }
    }

    function pollProgress() {
        console.log("Polling...");
        fetch('/progress')
            .then(response => response.json())
            .then(data => {
                const progressBar = document.getElementById('progress-bar-fill');
                const progressMessage = document.getElementById('progress-message');
                const progressText = document.getElementById('progress-text');
                const progressTime = document.getElementById('progress-time');
    
                // Actualiza la barra de progreso
                progressBar.style.width = data.percent + '%';
                progressBar.textContent = data.percent + '%';
    
                // Actualiza el tiempo transcurrido
                if (!isNaN(data.elapsed_time)) {
                    const minutes = Math.floor(data.elapsed_time / 60);
                    const seconds = data.elapsed_time % 60;
                    progressTime.innerText = `‚è±Ô∏è Elapsed Time: ${minutes}m ${seconds}s`;
                } else {
                    progressTime.innerText = ""; // En caso de que el tiempo sea inv√°lido
                }
                
                // Muestra el mensaje actual
                progressMessage.textContent = data.message;
    
                // Si el progreso est√° en curso, sigue actualizando cada 1 segundo
                if (data.status === 'running') {
                    setTimeout(pollProgress, 1000);
                }

                else if (data.status === 'stopped') {
                    inferenceRunning = false;
                    toggleButton();
                    alert(data.message)
                }

                else if (data.status === 'done') {
                    inferenceRunning = false;
                    toggleButton();
                    alert(data.message)
                }
            })
            .catch(error => console.error('Error en la solicitud de progreso:', error));
    }

    function startInference() {
        fetch('/run_inference', {method: 'POST'})
        .then(response => {
            inferenceRunning = true;
            toggleButton();
        })
        .catch(error => console.error('Error starting inference', error))
    }

    function stopInference() {    
        fetch('/stop_inference', {method: 'POST'})
        .then(response => {
            inferenceRunning = false;
            toggleButton();
        })
        .catch(error => console.error('Error stopping inference', error))
    }

    document.querySelector('form[action="/run_inference"]').addEventListener('submit', function(event) {
        event.preventDefault();
        console.log("Formulario enviado...");
        fetch('/run_inference', {
            method: 'POST',
        })
        .then(response => response.text())  // Espera la respuesta del servidor (la p√°gina renderizada)
        .then(data => {
            console.log("Respuesta recibida, comenzando polling...");
            // Iniciar el polling para actualizar los logs
            setInterval(pollProgress, 1000);
        })
        .catch(error => console.error('Error en la solicitud de inferencia:', error));
    });

    document.addEventListener('DOMContentLoaded', () => {
        toggleButton();
        document.getElementById('stop_inference_button').addEventListener('click', function (event) {
        event.preventDefault();
        stopInference();
    });
});
    
</script>
<script>
    // Obtain filename from the video selection to display it on UI
    const fileInput = document.getElementById('video');
    const fileNameSpan = document.getElementById('file-name');
    const uploadButton = document.getElementById('upload-button');
    const uploadMessage = document.getElementById('upload-message')
    
    fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
            fileNameSpan.textContent = this.files[0].name;
            uploadButton.style.display = 'inline-block';
    
            if (uploadMessage) {
                uploadMessage.style.display = 'none'
            }
            
        } else {
            fileNameSpan.textContent = '';
            uploadButton.style.display = 'none'
        }
    });
</script>
</body>
</html>
