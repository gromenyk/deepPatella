<!--
    DeepPatella – Baseline Tendon Length Calculation Page

    This page computes the tendon length at rest (baseline), which is required
    for all downstream stiffness computations.

    Responsibilities:
      • Load the first video frame and display model-predicted tendon insertions
        (distal and proximal markers)
      • Allow manual correction of these coordinates via canvas interaction
      • Allow the user to add extra waypoints along the tendon path to account
        for slack curvature
      • Compute tendon length in pixels using Catmull–Rom interpolation
        (via tendonCurve.js)
      • Convert pixel length to millimeters using the user-provided conversion
        factor
      • Store baseline tendon length and px→mm factor in localStorage so the
        stiffness module can use them later

    Dependencies:
      - tendonCurve.js → spline interpolation + curve length computation
      - baseline.js     → UI logic, canvas interaction, localStorage management
      - reset_ui.js     → reset button behavior shared across pages

    Notes:
      - The <body> tag embeds CSV URLs via data-* attributes for JS modules.
      - All coordinate inputs (#distal, #proximal, #extra1, #extra2) are filled 
        dynamically and must remain readonly.
      - The computed baseline mm value is saved under:
            deepPatella_baseline_mm
        and the conversion factor under:
            deepPatella_conversion_factor
-->


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepPatella</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/tendonCurve.js') }}"></script>
    <script src="{{ url_for('static', filename='js/baseline.js') }}"></script>
</head>
<body 
    data-distal-url="{{ url_for('static', filename='data/kalman_coords_distal.csv') }}"
    data-proximal-url="{{ url_for('static', filename='data/kalman_coords_proximal.csv') }}"
>
    <div class="banner">
        <h1>DeepPatella</h1>
        <p>Automatic quantification of patellar tendon stiffness</p>
    </div>
    <menu>
        <li class="{% if request.endpoint == 'home' %}active{% endif %}">
            <a href="{{ url_for('home') }}">Video Processing</a>
        </li>

        <li class="{% if request.endpoint == 'baseline_calculation' %}active{% endif %}">
            <a href="{{ url_for('baseline_calculation') }}">Baseline Calculation</a>
        </li>

        <li class="{% if request.endpoint == 'stiffness_calculation' %}active{% endif %}">
            <a href="{{ url_for('stiffness_calculation') }}">Tendon Stiffness Calculation</a>
        </li>
            <li id="reset-btn">Reset UI</li>
    </menu>

    <div class="baseline_calculation">
        <div class="title-baseline">
            <h1>BASELINE CALCULATION</h1>
            <p>This section is to obtain the tendon length at rest.</p>
            <p>Here you will find the first frame with the distal and proximal tendon-bone insertions predicted by the model. You can keep them or you can drag and drop them if you think they are misplaced.</p>
            <p>Also, to effectively calculate the tendon length, please add at least two more points in the image so the slack of the tendon is taken into account.</p>
        </div>

        <div class="baseline-container">
            <!-- Left block -->
            <div class="baseline-left">

                <!-- Coordinates card -->
                <div class="card">
                    <h3>Coordinates</h3>
                    <div class="baseline-mode-selector">
                        <span class="baseline-mode-label">Coordinate source:</span>

                        <label class="baseline-radio">
                            <input type="radio" name="baseline-mode" value="inference" checked>
                            <span>Model Inference</span>
                        </label>

                        <label class="baseline-radio">
                            <input type="radio" name="baseline-mode" value="manual">
                            <span>Manual Processing</span>
                        </label>
                    </div>
                    <div id="manual-video-upload" style="display:none;">
                        <label>
                            Upload video (first frame will be used)
                            <span class="info-icon"
                                data-tooltip="The first frame will be extracted and used for baseline definition.">
                            </span>
                        </label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input
                                type="file"
                                id="upload-baseline-video"
                                accept="video/*"
                            >
                            <button
                                id="upload-baseline-video-btn"
                                type="button">
                                Upload
                            </button>
                        </div>
                    </div>
                    <label for="distal">
                        Distal Tendon-Bone Insertion Coordinates
                        <span class="color-dot" style="background-color:#00FF00;"></span>
                    </label>
                    <input type="text" id="distal" value="Waiting for inference to be ready..." readonly>

                    <label for="proximal">
                        Proximal Tendon-Bone Insertion Coordinates
                        <span class="color-dot" style="background-color:#00BFFF;"></span>
                    </label>
                    <input type="text" id="proximal" value="Waiting for inference to be ready..." readonly>

                    <label for="extra1">
                        Extra Coordinates 1
                        <span class="color-dot" style="background-color:#FFA500;"></span>
                    </label>
                    <input type="text" id="extra1" placeholder="Click on the image" readonly>

                    <label for="extra2">
                        Extra Coordinates 2
                        <span class="color-dot" style="background-color:#FF00FF;"></span>
                    </label>
                    <input type="text" id="extra2" placeholder="Click on the image" readonly>
                </div>

                <!-- Results card -->
                <div class="card calculation-block"> 
                    <h3>Results</h3>
                    <button id="calculate-btn">Calculate tendon length (pixels)</button>
                    <label for="tendon-length">Tendon length (px)</label>
                    <input type="text" id="tendon-length" readonly>
                    <label for="conversion-factor">Pixel to Millimeter Conversion Factor</label>
                    <input type="text" id="conversion-factor" placeholder="e.g. 6.48">
                    <button id="convert-btn">Convert to mm</button>
                    <label for="tendon-length-mm">Tendon length (mm)</label>
                    <input type="text" id="tendon-length-mm" readonly>
                </div>
            </div>

            <!-- Right block -->
            <div class="baseline-right card">
                <h3>First Frame</h3>
                <div class="image-container">
                    <img id="tendon-frame"
                        src="{{ url_for('static', filename='img/placeholder.png') }}"
                        data-frame-url="{{ url_for('static', filename='img/frame_first.png') }}">
                    <canvas id="overlay"></canvas>
                </div>
            </div>
        </div>
    </div>
<script src="{{ url_for('static', filename='js/reset_ui.js') }}"></script>
</body>
</html>
